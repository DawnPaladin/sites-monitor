(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{13:function(e,t,a){e.exports=a(24)},21:function(e,t,a){},24:function(e,t,a){"use strict";a.r(t);var s=a(0),r=a.n(s),n=a(8),o=a.n(n),i=a(12),c=a(11),l=a(2),u=a(3),d=a(6),m=a(4),p=a(5),h=a(1),v=a(9),b=a.n(v),f=(a(19),a(21),function(e){function t(e){var a;return Object(l.a)(this,t),(a=Object(d.a)(this,Object(m.a)(t).call(this,e))).state={hasError:!1},a}return Object(p.a)(t,e),Object(u.a)(t,[{key:"componentDidCatch",value:function(e,t){console.warn(e)}},{key:"render",value:function(){return this.state.hasError?r.a.createElement("div",{className:"error"},r.a.createElement("h1",null,"Error")):this.props.children}}],[{key:"getDerivedStateFromError",value:function(e){return{hasError:!0}}}]),t}(r.a.Component)),k=a(10),g=a.n(k),j=function(e){function t(){return Object(l.a)(this,t),Object(d.a)(this,Object(m.a)(t).apply(this,arguments))}return Object(p.a)(t,e),Object(u.a)(t,[{key:"render",value:function(){var e=void 0===this.props.services?null:r.a.createElement("span",null,r.a.createElement("span",{className:"half-circle",style:{backgroundColor:this.props.shapeFillColor}}),this.props.services," services"),t=void 0===this.props.servers?null:r.a.createElement("span",null,r.a.createElement("span",{className:"square",style:{backgroundColor:this.props.shapeFillColor}}),this.props.servers," servers");return r.a.createElement("div",{className:"stat-line",style:{backgroundColor:this.props.backgroundColor}},r.a.createElement("strong",null,this.props.title,": "),r.a.createElement(g.a,{separator:", "},e,t))}}]),t}(r.a.Component),E=function(e){function t(){return Object(l.a)(this,t),Object(d.a)(this,Object(m.a)(t).apply(this,arguments))}return Object(p.a)(t,e),Object(u.a)(t,[{key:"render",value:function(){var e="diamond";return"SUCCESS"===this.props.buildResult?e+=" green":"FAILURE"===this.props.buildResult?e+=" red":e+=" grey",r.a.createElement("div",{className:e})}}]),t}(r.a.Component),w={SUCCESS:"succeeded",FAILURE:"failed",ABORTED:"aborted"},S=function(e){function t(e){var a;return Object(l.a)(this,t),(a=Object(d.a)(this,Object(m.a)(t).call(this,e))).formatTimeAgo=a.formatTimeAgo.bind(Object(h.a)(Object(h.a)(a))),a}return Object(p.a)(t,e),Object(u.a)(t,[{key:"formatTimeAgo",value:function(e){if(isNaN(e))return"";var t=Math.floor((new Date("Feb 27, 2019 12:19:00")-e)/1e3),a=Math.floor(t/86400);return 1===a?"1 day ago":a>1?"".concat(a," days ago"):1===(a=Math.floor(t/3600))?"1 hour ago":a>1?"".concat(a," hours ago"):1===(a=Math.floor(t/60))?"1 minute ago":a>1?"".concat(a," minutes ago"):"".concat(t," seconds ago")}},{key:"render",value:function(){var e=this,t=this.props.timestamps.map(function(t){var a=e.props.jobsByTimestamp[t],s=a.builds[0];return r.a.createElement("div",{key:t,className:"log-line"},r.a.createElement(E,{buildResult:s.result}),a.name," ",w[s.result]," ",e.formatTimeAgo(t))});return r.a.createElement("div",{className:"jenkins-log"},r.a.createElement("h2",null,"Jenkins build log"),t)}}]),t}(r.a.Component),y=function(e){function t(){return Object(l.a)(this,t),Object(d.a)(this,Object(m.a)(t).apply(this,arguments))}return Object(p.a)(t,e),Object(u.a)(t,[{key:"render",value:function(){var e=this,t=this.props.service.servers.map(function(t){return r.a.createElement("div",{className:"server indent",key:t.id},r.a.createElement("div",{className:"square "+e.props.serverColors[t.operational_status]}),r.a.createElement("div",{className:"server-name"},t.id))});return r.a.createElement("div",{className:"downed-service"},r.a.createElement("div",{className:"red circle"}),r.a.createElement("div",{className:"downed-service-name"},this.props.service.id),r.a.createElement("div",null,t))}}]),t}(r.a.Component),O=function(e){function t(){return Object(l.a)(this,t),Object(d.a)(this,Object(m.a)(t).apply(this,arguments))}return Object(p.a)(t,e),Object(u.a)(t,[{key:"render",value:function(){var e=this,t=this.props.downedServices.map(function(t){return r.a.createElement(y,{service:t,key:t.id,serverColors:e.props.serverColors})});return r.a.createElement("div",{className:"right-panel"},r.a.createElement(f,null,r.a.createElement(j,{title:"UP",backgroundColor:"hsla(115, 100%, 73.9%, 0.85)",shapeFillColor:"lime",services:this.props.serviceStats.up,servers:this.props.serverStats.up}),r.a.createElement(j,{title:"DISABLED",backgroundColor:"hsla(0, 0%, 75%, 0.85)",shapeFillColor:"gray",servers:this.props.serverStats.disabled}),r.a.createElement("div",{className:"downed"},this.props.simulateDownedService&&r.a.createElement("center",null,r.a.createElement("strong",null,"**SIMULATED**",r.a.createElement("br",null))),r.a.createElement(j,{title:"DOWN",shapeFillColor:"red",services:this.props.serviceStats.down,servers:this.props.serverStats.down}),r.a.createElement("div",{className:"downed-services"},t))),this.props.showLegend&&r.a.createElement("div",{className:"legend"},r.a.createElement("h2",null,"Legend"),r.a.createElement("img",{src:"/legend.svg",alt:"legend"})),r.a.createElement(f,null,r.a.createElement(S,{timestamps:this.props.jenkinsTimestamps,jobsByTimestamp:this.props.jenkinsJobsByTimestamp})))}}]),t}(r.a.Component),C={up:"green",down:"red"},N=function(e){function t(e){var a;return Object(l.a)(this,t),(a=Object(d.a)(this,Object(m.a)(t).call(this,e))).state={servers:a.props.system.servers},a.formatTimeAgo=a.formatTimeAgo.bind(Object(h.a)(Object(h.a)(a))),a.notTooLongAgo=a.notTooLongAgo.bind(Object(h.a)(Object(h.a)(a))),a.tierIndicator=a.tierIndicator.bind(Object(h.a)(Object(h.a)(a))),a}return Object(p.a)(t,e),Object(u.a)(t,[{key:"formatTimeAgo",value:function(e){if(isNaN(e))return"";var t=Math.floor((new Date("Feb 27, 2019 12:19:00")-e)/1e3),a=Math.floor(t/3600);return a>0?"".concat(a,"h"):(a=Math.floor(t/60))>0?"".concat(a,"m"):"".concat(t,"s")}},{key:"notTooLongAgo",value:function(e){return new Date("Feb 27, 2019 12:19:00").valueOf()-e<288e5}},{key:"tierIndicator",value:function(){var e=this.props.system.tier,t="tier-"+e.toLowerCase()+" "+C[this.props.system.status];return e?r.a.createElement("div",{className:t,title:this.props.system.id}):r.a.createElement("div",null)}},{key:"render",value:function(){var e=this,t=this.props.system.servers.map(function(t){return r.a.createElement("div",{className:"rect "+e.props.serverColors[t.operational_status],server:t,key:t.id,title:t.id})}),a=[],s=null;return this.props.system.jenkinsJobs&&this.props.system.jenkinsJobs.length&&this.props.system.jenkinsJobs[0].builds&&this.props.system.jenkinsJobs[0].builds.length&&(s=r.a.createElement(E,{buildResult:this.props.system.jenkinsJobs[0].builds[0].result}),a=this.props.system.jenkinsJobs.map(function(t){var a="build-viz";return"SUCCESS"===t.builds[0].result&&(a+=" green-text"),"FAILURE"===t.builds[0].result&&(a+=" red-text"),e.notTooLongAgo(t.builds[0].timestamp)||e.props.debugJenkins?r.a.createElement("div",{className:a,key:t.name,title:"Jenkins job: "+t.name},e.formatTimeAgo(t.builds[0].timestamp)):null})),r.a.createElement("div",{className:"down"===this.props.system.status?"downed system":"system"},r.a.createElement("div",{className:"circle-outline-"+C[this.props.system.status]},this.tierIndicator()),r.a.createElement("div",{className:"rects"},t),s,r.a.createElement("div",{className:"builds"},a))}}]),t}(s.Component);function L(e,t){var a=!1;return new Promise(function(s,r){var n=setTimeout(function(){a=!0,r(new Error("Request to ".concat(e," timed out")))},t);fetch(e).then(function(e){clearTimeout(n),a||s(e)}).catch(function(e){console.error(e),a||r(e)})}).catch(function(e){console.error(e)})}var T={enable:"green",disable:"grey","out-of-service-health":"red"},D=function(e){function t(e){var a;return Object(l.a)(this,t),(a=Object(d.a)(this,Object(m.a)(t).call(this,e))).state={groups:[],serviceStats:{up:0,down:0},serverStats:{up:0,disabled:0,down:0},downedServices:[],timeSinceLastUpdate:0,networkText:"Loading...",jobsByTimestamp:{},timestamps:[],showLegend:!0,hideCursor:!1},a.cursorVisibilityController=a.cursorVisibilityController.bind(Object(h.a)(Object(h.a)(a))),a.fetchLoopController=a.fetchLoopController.bind(Object(h.a)(Object(h.a)(a))),a.checkIfServiceIsDown=a.checkIfServiceIsDown.bind(Object(h.a)(Object(h.a)(a))),a.getLoadBalancerStatus=a.getLoadBalancerStatus.bind(Object(h.a)(Object(h.a)(a))),a.getJenkinsStatus=a.getJenkinsStatus.bind(Object(h.a)(Object(h.a)(a))),a.processLoadBalancerData=a.processLoadBalancerData.bind(Object(h.a)(Object(h.a)(a))),a.processJenkinsData=a.processJenkinsData.bind(Object(h.a)(Object(h.a)(a))),a.handleNetworkErr=a.handleNetworkErr.bind(Object(h.a)(Object(h.a)(a))),a}return Object(p.a)(t,e),Object(u.a)(t,[{key:"componentDidMount",value:function(){this.fetchLoopController().start(),this.cursorVisibilityController()}},{key:"cursorVisibilityController",value:function(){var e,t=this;document.onmousemove=function(e,t,a){var s;return function(){var r=this,n=arguments,o=a&&!s;clearTimeout(s),s=setTimeout(function(){s=null,a||e.apply(r,n)},t),o&&e.apply(r,n)}}(function(){t.setState({hideCursor:!1}),clearTimeout(e),e=setTimeout(function(){t.setState({hideCursor:!0})},5e3)},500,!0)}},{key:"fetchLoopController",value:function(){var e=this,t=function(){e.setState({networkStatus:"loading"}),Promise.all([e.getLoadBalancerStatus(),e.getJenkinsStatus()]).then(function(t){var a=Object(c.a)(t,2),s=a[0],r=a[1];"error"===s.error?window.location=s.redirect:"error"===r.error&&(window.location=r.redirect),e.processLoadBalancerData(s,function(){e.processJenkinsData(r)})},function(t){e.handleNetworkErr(t)}).finally(function(){e.setState({fetchLoop:setInterval(s,1e3),timeSinceLastUpdate:0,networkStatus:"waiting"})})},a=function(){clearInterval(e.state.fetchLoop),e.setState({timeSinceLastUpdate:0,networkStatus:"stopped"})},s=function(){e.setState({frequencyToCheck:15}),null!=e.state.serverStats&&null!=e.state.serviceStats&&null!=e.state.jenkinsStats&&(e.state.serverStats.down>0||e.state.serviceStats.down>0||e.state.jenkinsStats.building>0)&&e.setState({frequencyToCheck:5}),e.state.timeSinceLastUpdate>e.state.frequencyToCheck-1?(a(),t(),e.setState({showLegend:!1})):e.setState({timeSinceLastUpdate:e.state.timeSinceLastUpdate+1})};return{start:t,stop:a}}},{key:"checkIfServiceIsDown",value:function(e){var t=0,a=parseInt(e.minimum_notificate_real_server);return e.servers.forEach(function(e){"out-of-service-health"===e.operational_status&&(t+=1)}),t>0&&t>=a}},{key:"getLoadBalancerStatus",value:function(){var e=this;return L("/sites-monitor/load-balancer.json",15e3).then(function(t){return void 0===t?(e.handleNetworkErr({message:"Load Balancer is not responding"}),!1):t.ok?t.json():void e.handleNetworkErr(t)}).catch(function(t){e.handleNetworkErr(t)})}},{key:"processLoadBalancerData",value:function(e,t){var a=this;if(!e)return!1;var s=function(e){return e.replace(/_/g," ")};this.setState({loading:!0});var r=e.data;r.sort(function(e,t){var a=e.id.toUpperCase(),s=t.id.toUpperCase();return a<s?-1:a>s?1:0}),r.forEach(function(e){e.id=s(e.id),e.virtual_services.forEach(function(e){e.id=s(e.id)})}),this.setState({groups:r});var n={up:0,down:0},o={up:0,disabled:0,down:0};this.setState({downedServices:[]}),r[10].virtual_services[3].servers[0].operational_status="out-of-service-health",r.forEach(function(e){e.virtual_services.forEach(function(e){a.checkIfServiceIsDown(e)?(e.status="down",n.down+=1,a.setState({downedServices:Object(i.a)(a.state.downedServices).concat([e])})):(e.status="up",n.up+=1),e.jenkinsJobs=[],e.servers.forEach(function(e){"enable"===e.operational_status?o.up+=1:"disable"===e.operational_status?o.disabled+=1:"out-of-service-health"===e.operational_status?o.down+=1:console.warn("Unexpected server status",e.operational_status)})})}),this.setState({serviceStats:n,serverStats:o},t)}},{key:"getJenkinsStatus",value:function(){var e=this;return L("/sites-monitor/jenkins.json",1e4).then(function(t){return void 0===t?(e.handleNetworkErr({message:"Jenkins server is not responding"}),!1):t.ok?t.json():void e.handleNetworkErr(t)})}},{key:"processJenkinsData",value:function(e){var t={up:0,down:0,building:0};this.setState(function(a){var s=a.groups,r=[],n=/\[(.+?)\]/g;a.timestamps=[];for(var o=function(){var o=e.pop(),i=!1;if("disabled"===o.color)return"continue";if(s.forEach(function(e){e.virtual_services.forEach(function(e){for(var a,s=[];a=n.exec(o.description);)s.push(a[1]);var r=s&&s.some(function(t){return t===e.id});if((o.name===e.id||o.name===function(e){var t=e.split(" "),a=t.pop();return t.push("(".concat(a,")")),t.join(" ")}(e.id)||o.name===e.id.replace("UAT","Staging")||o.name===e.id.replace("UAT","(Staging)")||r)&&(e.jenkinsJobs.push(o),i=!0,o.builds.length>0))switch(w[o.builds[0].result]){case"succeeded":t.up+=1;break;case"failed":t.down+=1;break;case"aborted":break;default:t.building+=1}})}),i||r.push(o),o.builds.length){var c=o.builds[0].timestamp;a.timestamps.push(c),a.jobsByTimestamp[c]=o}};e.length>0;)o();a.timestamps.sort(),a.timestamps.reverse(),a.timestamps=a.timestamps.slice(0,15),a.jenkinsStats=t})}},{key:"handleNetworkErr",value:function(e){return this.setState({networkText:e.message,groups:[]}),e}},{key:"render",value:function(){var e=this.state.groups.map(function(e,t){return r.a.createElement(J,{key:t,group:e})});0===e.length&&(e=r.a.createElement("div",{className:"network-text"},this.state.networkText));var t=100*this.state.timeSinceLastUpdate/this.state.frequencyToCheck;return r.a.createElement("div",{id:"App",className:this.state.hideCursor?"hide-cursor":""},r.a.createElement("div",{className:"monitor"},r.a.createElement(f,null,r.a.createElement("ul",{className:"groups"},e)),r.a.createElement(f,null,r.a.createElement("div",{id:"network-status",className:this.state.networkStatus,onClick:this.fetchLoopController().stop},r.a.createElement(b.a,{percentage:t,styles:{path:{stroke:"lime",strokeWidth:".05em",strokeLinecap:"butt",strokeDasharray:"4"},trail:{stroke:"hsl(0, 0%, 10%)",strokeWidth:"0.05em"}}})))),r.a.createElement(O,{serverColors:T,serviceStats:this.state.serviceStats,serverStats:this.state.serverStats,downedServices:this.state.downedServices,simulateDownedService:!0,showLegend:this.state.showLegend,jenkinsTimestamps:this.state.timestamps,jenkinsJobsByTimestamp:this.state.jobsByTimestamp}))}}]),t}(s.Component),J=function(e){var t=e.group.virtual_services.map(function(e){return r.a.createElement(N,{key:e.name,system:e,debugJenkins:!1,serverColors:T})});return t.length>0?r.a.createElement("li",{className:"group"},e.group.id,t):r.a.createElement("div",null)},A=D;Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(r.a.createElement(A,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(e){e.unregister()})}},[[13,2,1]]]);
//# sourceMappingURL=main.d4a4fff9.chunk.js.map