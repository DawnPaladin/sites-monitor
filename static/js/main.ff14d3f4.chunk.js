(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{12:function(e,t,a){e.exports=a(23)},20:function(e,t,a){},23:function(e,t,a){"use strict";a.r(t);var s=a(0),n=a.n(s),r=a(8),o=a.n(r),i=a(10),c=a(11),l=a(2),u=a(3),m=a(5),d=a(4),p=a(6),v=a(1),h=a(9),f=a.n(h),b=(a(18),a(20),function(e){function t(){return Object(l.a)(this,t),Object(m.a)(this,Object(d.a)(t).apply(this,arguments))}return Object(p.a)(t,e),Object(u.a)(t,[{key:"render",value:function(){var e="diamond";return"SUCCESS"===this.props.buildResult?e+=" green":"FAILURE"===this.props.buildResult?e+=" red":e+=" grey",n.a.createElement("div",{className:e})}}]),t}(n.a.Component)),g={up:"green",down:"red"},E=function(e){function t(e){var a;return Object(l.a)(this,t),(a=Object(m.a)(this,Object(d.a)(t).call(this,e))).state={servers:a.props.system.servers},a.formatTimeAgo=a.formatTimeAgo.bind(Object(v.a)(Object(v.a)(a))),a.notTooLongAgo=a.notTooLongAgo.bind(Object(v.a)(Object(v.a)(a))),a.tierIndicator=a.tierIndicator.bind(Object(v.a)(Object(v.a)(a))),a}return Object(p.a)(t,e),Object(u.a)(t,[{key:"formatTimeAgo",value:function(e){if(isNaN(e))return"";var t=Math.floor((new Date-e)/1e3),a=Math.floor(t/3600);return a>0?"".concat(a,"h"):(a=Math.floor(t/60))>0?"".concat(a,"m"):"".concat(t,"s")}},{key:"notTooLongAgo",value:function(e){return(new Date).valueOf()-e<288e5}},{key:"tierIndicator",value:function(){var e=this.props.system.tier,t="tier-"+e.toLowerCase()+" "+g[this.props.system.status];return e?n.a.createElement("div",{className:t,title:this.props.system.id}):n.a.createElement("div",null)}},{key:"render",value:function(){var e=this,t=this.props.system.servers.map(function(t){return n.a.createElement("div",{className:"rect "+e.props.serverColors[t.operational_status],server:t,key:t.id,title:t.id})}),a=[],s=null;return this.props.system.jenkinsJobs&&this.props.system.jenkinsJobs.length&&(s=n.a.createElement(b,{buildResult:this.props.system.jenkinsJobs[0].builds[0].result}),a=this.props.system.jenkinsJobs.map(function(t){var a="build-viz";return"SUCCESS"===t.builds[0].result&&(a+=" green-text"),"FAILURE"===t.builds[0].result&&(a+=" red-text"),e.notTooLongAgo(t.builds[0].timestamp)||e.props.debugJenkins?n.a.createElement("div",{className:a,key:t.name,title:"Jenkins job: "+t.name},e.formatTimeAgo(t.builds[0].timestamp)):null})),n.a.createElement("div",{className:"down"===this.props.system.status?"downed system":"system"},n.a.createElement("div",{className:"circle-outline-"+g[this.props.system.status]},this.tierIndicator()),n.a.createElement("div",{className:"rects"},t),s,n.a.createElement("div",{className:"builds"},a))}}]),t}(s.Component),k={SUCCESS:"succeeded",FAILURE:"failed",ABORTED:"aborted"},j=function(e){function t(e){var a;return Object(l.a)(this,t),(a=Object(m.a)(this,Object(d.a)(t).call(this,e))).formatTimeAgo=a.formatTimeAgo.bind(Object(v.a)(Object(v.a)(a))),a}return Object(p.a)(t,e),Object(u.a)(t,[{key:"formatTimeAgo",value:function(e){if(isNaN(e))return"";var t=Math.floor((new Date("Feb 27, 2019 12:19:00")-e)/1e3),a=Math.floor(t/86400);return 1===a?"1 day ago":a>1?"".concat(a," days ago"):1===(a=Math.floor(t/3600))?"1 hour ago":a>1?"".concat(a," hours ago"):1===(a=Math.floor(t/60))?"1 minute ago":a>1?"".concat(a," minutes ago"):"".concat(t," seconds ago")}},{key:"render",value:function(){var e=this,t=this.props.timestamps.map(function(t){var a=e.props.jobsByTimestamp[t],s=a.builds[0];return n.a.createElement("div",{key:t,className:"log-line"},n.a.createElement(b,{buildResult:s.result}),a.name," ",k[s.result]," ",e.formatTimeAgo(t))});return n.a.createElement("div",{className:"jenkins-log"},n.a.createElement("h2",null,"Jenkins build log"),t)}}]),t}(n.a.Component);var w={enable:"green",disable:"grey","out-of-service-health":"red"},S=function(e){function t(e){var a;return Object(l.a)(this,t),(a=Object(m.a)(this,Object(d.a)(t).call(this,e))).state={groups:[],serviceStats:{up:0,down:0},serverStats:{up:0,disabled:0,down:0},downedServices:[],timeSinceLastUpdate:0,networkText:"Loading...",jobsByTimestamp:{},timestamps:[]},a.fetchLoopController=a.fetchLoopController.bind(Object(v.a)(Object(v.a)(a))),a.checkIfServiceIsDown=a.checkIfServiceIsDown.bind(Object(v.a)(Object(v.a)(a))),a.getLoadBalancerStatus=a.getLoadBalancerStatus.bind(Object(v.a)(Object(v.a)(a))),a.getJenkinsStatus=a.getJenkinsStatus.bind(Object(v.a)(Object(v.a)(a))),a.processLoadBalancerData=a.processLoadBalancerData.bind(Object(v.a)(Object(v.a)(a))),a.processJenkinsData=a.processJenkinsData.bind(Object(v.a)(Object(v.a)(a))),a.handleNetworkErr=a.handleNetworkErr.bind(Object(v.a)(Object(v.a)(a))),a}return Object(p.a)(t,e),Object(u.a)(t,[{key:"componentDidMount",value:function(){this.fetchLoopController().start()}},{key:"fetchLoopController",value:function(){var e=this,t=function(){e.setState({networkStatus:"loading"}),Promise.all([e.getLoadBalancerStatus(),e.getJenkinsStatus()]).then(function(t){var a=Object(c.a)(t,2),s=a[0],n=a[1];"error"===s.error?window.location=s.redirect:"error"===n.error&&(window.location=n.redirect),e.processLoadBalancerData(s,function(){e.processJenkinsData(n)})},function(t){e.handleNetworkErr(t)}).then(function(){e.setState({fetchLoop:setInterval(s,1e3),timeSinceLastUpdate:0,networkStatus:"waiting"})})},a=function(){clearInterval(e.state.fetchLoop),e.setState({timeSinceLastUpdate:0,networkStatus:"stopped"})},s=function(){e.state.timeSinceLastUpdate>29?(a(),t()):e.setState({timeSinceLastUpdate:e.state.timeSinceLastUpdate+1})};return{start:t,stop:a}}},{key:"checkIfServiceIsDown",value:function(e){var t=0,a=parseInt(e.minimum_notificate_real_server);return e.servers.forEach(function(e){"out-of-service-health"===e.operational_status&&(t+=1)}),t>0&&t>=a}},{key:"getLoadBalancerStatus",value:function(){var e=this;return fetch("/sites-monitor/load-balancer.json").then(function(t){if(t.ok)return t.json();e.handleNetworkErr(t)})}},{key:"processLoadBalancerData",value:function(e,t){var a=this,s=function(e){return e.replace(/_/g," ")};this.setState({loading:!0});var n=e.data;n.sort(function(e,t){var a=e.id.toUpperCase(),s=t.id.toUpperCase();return a<s?-1:a>s?1:0}),n.forEach(function(e){e.id=s(e.id),e.virtual_services.forEach(function(e){e.id=s(e.id)})}),this.setState({groups:n});var r={up:0,down:0},o={up:0,disabled:0,down:0};this.setState({downedServices:[]}),n[8].virtual_services[3].servers[1].operational_status="out-of-service-health",n.forEach(function(e){e.virtual_services.forEach(function(e){a.checkIfServiceIsDown(e)?(e.status="down",r.down+=1,a.setState({downedServices:Object(i.a)(a.state.downedServices).concat([e])})):(e.status="up",r.up+=1),e.jenkinsJobs=[],e.servers.forEach(function(e){"enable"===e.operational_status?o.up+=1:"disable"===e.operational_status?o.disabled+=1:"out-of-service-health"===e.operational_status?o.down+=1:console.warn("Unexpected server status",e.operational_status)})})}),this.setState({serviceStats:r,serverStats:o},t)}},{key:"getJenkinsStatus",value:function(){var e=this;return fetch("/sites-monitor/jenkins.json").then(function(t){if(t.ok)return t.json();e.handleNetworkErr(t)})}},{key:"processJenkinsData",value:function(e){this.setState(function(t){var a=t.groups,s=[],n=/\[(.+?)\]/g;t.timestamps=[];for(var r=function(){var r=e.pop(),o=!1;if("disabled"===r.color)return"continue";a.forEach(function(e){e.virtual_services.forEach(function(e){for(var t,a=[];t=n.exec(r.description);)a.push(t[1]);var s=a&&a.some(function(t){return t===e.id});(r.name===e.id||r.name===function(e){var t=e.split(" "),a=t.pop();return t.push("(".concat(a,")")),t.join(" ")}(e.id)||r.name===e.id.replace("UAT","Staging")||r.name===e.id.replace("UAT","(Staging)")||s)&&(e.jenkinsJobs.push(r),o=!0)})}),o||s.push(r);var i=r.builds[0].timestamp;t.timestamps.push(i),t.jobsByTimestamp[i]=r};e.length>0;)r();t.timestamps.sort(),t.timestamps.reverse(),t.timestamps=t.timestamps.slice(0,15)})}},{key:"handleNetworkErr",value:function(e){return this.setState({networkText:e.message,groups:[]}),e}},{key:"render",value:function(){var e=this.state.groups.map(function(e,t){return n.a.createElement(y,{key:t,group:e})});0===e.length&&(e=n.a.createElement("div",{className:"network-text"},this.state.networkText));var t=this.state.downedServices.map(function(e){return n.a.createElement(O,{service:e,key:e.id})}),a=100*this.state.timeSinceLastUpdate/30;return n.a.createElement("div",{id:"App"},n.a.createElement("div",{className:"monitor"},n.a.createElement("ul",{className:"groups"},e),n.a.createElement("div",{id:"network-status",className:this.state.networkStatus,onClick:this.fetchLoopController().stop},n.a.createElement(f.a,{percentage:a,styles:{path:{stroke:"lime",strokeWidth:".05em",strokeLinecap:"butt",strokeDasharray:"4"},trail:{stroke:"hsl(0, 0%, 10%)",strokeWidth:"0.05em"}}}))),n.a.createElement("div",{className:"stats"},n.a.createElement("div",{className:"stat-line stat-line-green"},n.a.createElement("strong",null,"UP: "),n.a.createElement("span",{className:"half-circle green"}),n.a.createElement("span",null,this.state.serviceStats.up," services,"),n.a.createElement("span",{className:"square green"}),n.a.createElement("span",null,this.state.serverStats.up," servers")),n.a.createElement("div",{className:"stat-line stat-line-grey"},n.a.createElement("strong",null,"DISABLED: "),n.a.createElement("span",{className:"square grey"}),n.a.createElement("span",null,this.state.serverStats.disabled," servers")),n.a.createElement("div",{className:"downed"},n.a.createElement("div",{className:"stat-line stat-line-red"},n.a.createElement("strong",null,"**SIMULATED**",n.a.createElement("br",null)),n.a.createElement("strong",null,"DOWN: "),n.a.createElement("span",{className:"half-circle red"}),n.a.createElement("span",null,this.state.serviceStats.down," services,"),n.a.createElement("span",{className:"square red"}),n.a.createElement("span",null,this.state.serverStats.down," servers")),n.a.createElement("div",{className:"downed-services"},t)),n.a.createElement("div",{className:"legend"},n.a.createElement("h2",null,"Legend"),n.a.createElement("img",{src:"/sites-monitor/legend.svg",alt:"legend"})),n.a.createElement(j,{timestamps:this.state.timestamps,jobsByTimestamp:this.state.jobsByTimestamp})))}}]),t}(s.Component),y=function(e){var t=e.group.virtual_services.map(function(e){return n.a.createElement(E,{key:e.name,system:e,debugJenkins:!1,serverColors:w})});return n.a.createElement("li",{className:"group"},e.group.id,t)},O=function(e){function t(){return Object(l.a)(this,t),Object(m.a)(this,Object(d.a)(t).apply(this,arguments))}return Object(p.a)(t,e),Object(u.a)(t,[{key:"render",value:function(){var e=this.props.service.servers.map(function(e){return n.a.createElement("div",{className:"server indent",key:e.id},n.a.createElement("div",{className:"square "+w[e.operational_status]}),n.a.createElement("div",{className:"server-name"},e.id))});return n.a.createElement("div",{className:"downed-service"},n.a.createElement("div",{className:"red circle"}),n.a.createElement("div",{className:"downed-service-name"},this.props.service.id),n.a.createElement("div",null,e))}}]),t}(s.Component),N=S;Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(n.a.createElement(N,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(e){e.unregister()})}},[[12,2,1]]]);
//# sourceMappingURL=main.ff14d3f4.chunk.js.map